# 배움기록 시스템 구조 문서

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [학생 페이지 UI 최종 구조](#학생-페이지-ui-최종-구조)
3. [데이터베이스 스키마](#데이터베이스-스키마)
4. [관리자 페이지 재설계](#관리자-페이지-재설계)
5. [구현 계획](#구현-계획)

---

## 시스템 개요

### 목적
학생들이 매일 학습 내용을 기록하고, 교사가 이를 확인하여 AI로 생활기록부 형식으로 변환하는 시스템

### 주요 기능
- **학생**: 핵심배움 작성 + 학습과정 체크리스트 선택
- **교사**: 학생 기록 조회 → AI 변환 → 승인/삭제 → Excel 다운로드

---

## 학생 페이지 UI 최종 구조

### 1. 전체 레이아웃

```
┌─────────────────────────────────────────────────────────┐
│                    도움알림판                            │
│  (클릭 시 플립 → 배움기록 화면)                          │
└─────────────────────────────────────────────────────────┘
```

### 2. 플립 후 배움기록 화면

```
┌───────────────────────────────────────────────────────────┐
│                      배움기록                             │
│                   (DaHyun, 30px, 검정, 중앙)              │
├─────────────────────────┬─────────────────────────────────┤
│  1. 오늘의 핵심배움      │  2. 학습과정 돌아보기            │
│  (DaHyun, 18px, 검정)   │  (DaHyun, 18px, 검정)           │
├─────────────────────────┼─────────────────────────────────┤
│                         │                                 │
│  ┌───────────────────┐  │  ┌──────────┬──────────┐       │
│  │                   │  │  │ ☐ 친구   │ ☐ 용기   │       │
│  │  [Textarea]       │  │  │   도와줌 │   질문함 │       │
│  │  (15px)           │  │  ├──────────┼──────────┤       │
│  │                   │  │  │ ☐ 계획   │ ☐ 해결   │       │
│  │                   │  │  │   세움   │   함     │       │
│  └───────────────────┘  │  ├──────────┼──────────┤       │
│                         │  │ ☐ 새방법 │ ☐ 귀담아 │       │
│  0/300자 (12px, 검정)   │  │   시도   │   들음   │       │
│  예) 영어... (12px,회색)│  ├──────────┼──────────┤       │
│                         │  │ ☐ 협력   │ ☐ 자신감 │       │
│                         │  │   해결   │   발표   │       │
│                         │  └──────────┴──────────┘       │
└─────────────────────────┴─────────────────────────────────┘
              [임시저장]  [제출하기]
           (15px, 회색) (15px, 파스텔블루)
```

### 3. 상세 스타일 가이드

#### 색상 팔레트
```css
/* 기본 */
--background: #FAFAFA (연한 회색)
--border: #E0E0E0 (회색)
--text-primary: #333 (검정)
--text-secondary: #666 (회색)

/* 포인트 */
--primary-color: #B8D4D9 (파스텔 블루 - 헤더 색상)
--checkbox-checked: #B8D4D9 (체크박스 선택 시)
--checkbox-border: #D0D0D0 (체크박스 기본 테두리)
```

#### 폰트 크기
```css
제목 (배움기록): 30px
섹션 제목: 18px
Textarea: 15px
체크리스트: 14px
예시/카운터: 12px
버튼: 15px
```

#### 체크박스 스타일
- **기본**: 흰색 배경 + 회색 테두리 (#D0D0D0)
- **체크 시**: 파스텔 블루 배경 (#B8D4D9) + 흰색 체크 표시 (✓)
- **크기**: 18px × 18px

### 4. 플립 동작 규칙

**플립 작동 영역**:
- ✅ 제목 "배움기록" 클릭
- ✅ 섹션 박스 외부 빈 공간
- ✅ 버튼 영역 외부

**플립 방지 영역**:
- ❌ Textarea 클릭
- ❌ 체크박스 클릭
- ❌ 체크박스 텍스트 클릭
- ❌ 섹션 제목 클릭
- ❌ 섹션 박스 내부
- ❌ 버튼 클릭

---

## 데이터베이스 스키마

### learning_records 테이블

```sql
CREATE TABLE learning_records (
  -- 기본 키
  record_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- 학생 정보
  student_id TEXT NOT NULL REFERENCES students(student_id),
  
  -- 기록 날짜
  record_date DATE NOT NULL,
  
  -- ===== 학생 입력 데이터 =====
  -- 1. 오늘의 핵심배움
  core_learning TEXT,
  
  -- 2. 학습과정 돌아보기 (JSON 배열)
  learning_process JSONB DEFAULT '[]'::jsonb,
  
  -- ===== 삭제된 필드 =====
  -- thoughts_and_questions TEXT,  -- 3. 나의 생각과 질문 (제거됨)
  
  -- ===== AI 변환 결과 =====
  ai_converted_record TEXT,
  
  -- ===== 승인 관리 =====
  is_approved BOOLEAN DEFAULT false,
  approved_at TIMESTAMPTZ,
  
  -- ===== 메타데이터 =====
  is_submitted BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  submitted_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 제약 조건
  CONSTRAINT unique_student_date UNIQUE(student_id, record_date)
);
```

### 학습과정 체크리스트 항목 (8개)

```json
[
  "친구 어려워하는 것 도와줌",
  "용기내어 질문함",
  "공부 순서 정하기 등 계획세움",
  "포기하지 않고 해결함",
  "새로운 방법으로 시도함",
  "친구 말을 귀담아 들음",
  "친구들과 협력해서 문제해결함",
  "대화 또는 발표할 때 자신있게 말했음"
]
```

---

## 관리자 페이지 재설계

### 1. 위치 및 구조

**위치**: AI생기부 탭 내부 → "배움기록 관리" 쪽버튼

```
┌─────────────────────────────────────────────────────────┐
│  AI생기부                                                │
├─────────────────────────────────────────────────────────┤
│  [도움내용 관리 ▼]  [배움기록 관리 ▼]                    │
├─────────────────────────────────────────────────────────┤
│  (선택된 섹션 내용 표시)                                  │
└─────────────────────────────────────────────────────────┘
```

### 2. 배움기록 관리 테이블 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│  학급/학년 검색: [3-1 ▼]  [전체 다운로드 📥]                             │
├────┬──────┬────────┬──────────────┬──────────────┬────────┬──────┤
│번호│학생명│날짜 ▼  │핵심배움      │학습과정      │AI변환  │작업  │
├────┼──────┼────────┼──────────────┼──────────────┼────────┼──────┤
│ 1  │고유원│2025-10-│분수의 덧셈에서│✓ 친구도움    │[변환]  │[승인]│
│    │      │05 ▼   │분모를 같게...│✓ 질문        │        │[삭제]│
│    │      │        │              │✓ 끝까지      │        │      │
├────┼──────┼────────┼──────────────┼──────────────┼────────┼──────┤
│ 2  │김지성│2025-10-│영어 동작 단어│✓ 계획        │고유원은│[승인]│
│    │      │05      │5개 따라말하기│✓ 협력        │분수의..│[삭제]│
└────┴──────┴────────┴──────────────┴──────────────┴────────┴──────┘
```

### 3. 테이블 컬럼 상세

| 컬럼 | 설명 | 너비 |
|------|------|------|
| **번호** | 순번 | 5% |
| **학생명** | 이름 + 날짜 토글 버튼 | 10% |
| **날짜** | 최신 기록 날짜 (▼ 클릭 시 과거 날짜 목록) | 12% |
| **핵심배움** | core_learning (최대 50자 표시, 말줄임) | 25% |
| **학습과정** | learning_process (체크된 항목만 표시) | 20% |
| **AI변환** | ai_converted_record 또는 [변환] 버튼 | 18% |
| **작업** | [승인] [삭제] 버튼 | 10% |

### 4. 주요 기능

#### 4.1 날짜 토글 (쪽버튼)
```
고유원 ▼
  ├─ 2025-10-05 (최신) ✓
  ├─ 2025-10-04
  └─ 2025-10-03
```
- 클릭 시 해당 날짜 기록으로 행 내용 교체
- 최신 기록이 기본 표시

#### 4.2 학습과정 표시
```
✓ 친구 도움
✓ 질문
✓ 끝까지 해결
```
- 체크된 항목만 표시
- 최대 3개까지 표시, 나머지는 "+2" 형식

#### 4.3 AI 변환
**변환 전**:
```
[변환] 버튼
```

**변환 후**:
```
고유원은 분수의 덧셈에서 분모를 통분하는 방법을 이해하였으며,
친구를 도와주고 적극적으로 질문하는 등 협력적 학습 태도를 보임.
```

**AI 프롬프트**:
```
다음 학생의 배움기록을 생활기록부 형식으로 변환해주세요.

학생명: {student_name}
날짜: {record_date}
핵심배움: {core_learning}
학습과정: {learning_process 배열을 문장으로}

생활기록부 형식:
- 2-3문장으로 요약
- 학생의 학습 내용과 태도를 포함
- 존댓말 사용 (예: ~하였으며, ~보임)
```

#### 4.4 승인/삭제
- **승인**: `is_approved = true`, `approved_at = NOW()`
- **삭제**: 해당 기록 삭제 (soft delete 또는 hard delete)

#### 4.5 Excel 다운로드
**파일명**: `배움기록_3학년1반_20251005.xlsx`

**컬럼**:
| 번호 | 학생명 | 날짜 | 핵심배움 | 학습과정 | AI 변환 내용 |
|------|--------|------|----------|----------|--------------|

---

## 구현 계획

### Phase 1: 데이터베이스 수정 ✅
- [x] `thoughts_and_questions` 필드 제거 (또는 NULL 허용)
- [x] 스키마 문서 업데이트

### Phase 2: 학생 페이지 완성 ✅
- [x] 3단 → 2단 레이아웃 변경
- [x] 체크리스트 2열 배치
- [x] 플립 동작 개선
- [x] 색상/폰트 최적화
- [x] 커스텀 체크박스 스타일

### Phase 3: 관리자 페이지 구현 (대기 중)
#### 3.1 기본 구조
- [ ] AI생기부 탭에 "배움기록 관리" 쪽버튼 추가
- [ ] 테이블 레이아웃 구성
- [ ] 학급/학년 검색 필터

#### 3.2 데이터 조회
- [ ] 최신 기록 조회 API
  - `GET /api/learning-records/latest?class=3-1`
  - DISTINCT ON (student_id) ORDER BY record_date DESC
- [ ] 학생별 과거 기록 조회 API
  - `GET /api/learning-records/student/:studentId`

#### 3.3 날짜 토글 기능
- [ ] 학생명 옆 ▼ 버튼
- [ ] 날짜 목록 드롭다운
- [ ] 선택 시 행 데이터 교체

#### 3.4 AI 변환 기능
- [ ] Gemini API 연동
- [ ] 프롬프트 템플릿 작성
- [ ] [변환] 버튼 클릭 시 AI 호출
- [ ] 결과 저장 (`ai_converted_record`)

#### 3.5 승인/삭제 기능
- [ ] 승인 API: `PATCH /api/learning-records/:id/approve`
- [ ] 삭제 API: `DELETE /api/learning-records/:id`
- [ ] UI 상태 업데이트

#### 3.6 Excel 다운로드
- [ ] `xlsx` 라이브러리 사용
- [ ] 현재 조회된 학급의 모든 승인된 기록 다운로드
- [ ] 파일명: `배움기록_{학급}_{날짜}.xlsx`

### Phase 4: 테스트 및 최적화
- [ ] 학생 페이지 제출 테스트
- [ ] 관리자 페이지 조회 테스트
- [ ] AI 변환 품질 검증
- [ ] 성능 최적화 (쿼리, 캐싱)

---

## 기술 스택

### Frontend
- React + Vite
- CSS Modules
- Custom CSS (체크박스)

### Backend
- Supabase (PostgreSQL)
- Supabase Realtime (선택적)

### AI
- Google Gemini API

### Excel
- `xlsx` 라이브러리

---

## 파일 구조

```
src/
├── modules/
│   ├── student/
│   │   ├── LearningRecordPanel.jsx       # 학생 배움기록 UI
│   │   ├── LearningRecordPanel.css       # 커스텀 체크박스 스타일
│   │   └── HelpNotificationModule.jsx    # 도움알림판 (플립 컨테이너)
│   └── admin/
│       └── LearningRecordAdmin.jsx       # 관리자 배움기록 관리 (구현 예정)
├── services/
│   ├── learningRecordService.js          # API 호출 함수
│   └── geminiService.js                  # AI 변환 서비스
└── database/
    └── learning_records_schema.sql       # DB 스키마
```

---

## 변경 이력

### 2025-10-05 (최종)
- **UI 변경**: 3단 → 2단 레이아웃 (나의 생각과 질문 제거)
- **체크리스트**: 8개 항목 2열 배치
- **색상**: 포인트 컬러 제거, 파스텔 블루 강조
- **체크박스**: 커스텀 스타일 (회색 테두리 → 파스텔 블루 체크)
- **플립**: 입력 영역 클릭 방지 강화
- **관리자 페이지**: 재설계 (테이블 구조 변경)
- **프롬프트 개선**: 주어 제거, 생기부 형식 최적화
- **Excel 다운로드**: 배움기록 및 도움내용 전체 다운로드 기능 추가
- **메시지 스타일**: 파스텔 블루 배경 + 흰색 글자 + 왼쪽 정렬
- **로딩 메시지 제거**: "처리 중..." 메시지 제거, 최종 결과만 표시

---

## 구현 완료 상태

### ✅ 완료된 기능
- [x] 학생 페이지: 배움기록 작성 UI
- [x] 관리자 페이지: 배움기록 관리 (조회, AI 변환, 승인, 삭제)
- [x] AI 변환: Gemini API 연동 (생기부 형식)
- [x] Excel 다운로드: 배움기록 및 도움내용
- [x] 데이터베이스: learning_records 테이블

### 🔄 테스트 필요
- [ ] 학생 페이지에서 배움기록 제출
- [ ] 관리자 페이지에서 조회 및 AI 변환
- [ ] Excel 다운로드 기능
- [ ] 승인/삭제 기능
